# Cave-Escape 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
Cave-Escape

### 1.2 プロジェクト概要
右スクロール（左から右）アクションゲーム。洞窟を進むロケットを操作し、壁に接触することなく目標距離まで進むワンボタンゲーム。モバイル対応のタッチ操作にも対応。

### 1.3 目的
シンプルな操作で楽しめるアクションゲームの提供。GitHub Pagesでの公開を想定。モバイルデバイスでも快適にプレイ可能。

## 2. ゲーム仕様

### 2.1 基本ルール
- **操作方法**: スペースキー（PC）/ タップ（モバイル）
  - スペースキー押下中/タップ中: ロケット上昇
  - スペースキー離す/タップ離す: ロケット下降
  - ロケットは画面左側に配置、右を向いている
- **ゲームオーバー条件**: ロケットが洞窟の壁に接触
- **クリア条件**: 各ステージの目標距離に到達
- **スコア**: 進んだ距離（km）で表示
 - **距離単位・換算**: ゲーム内 1px = 10m（1km = 100px）。表示はkm、小数1桁で丸め（例: 12.3km）。
 - **ステージ別クリア距離**: ステージ1: 50km、ステージ2: 75km、ステージ3: 100km、ステージ4: 40km、ステージ5: 150km

### 2.2 物理特性
- **重力**: スペースキーを離すと放物線を描いて下降
- **上昇力**: スペースキー押下中は放物線を描いて上昇
- **慣性**: あり（物理的な動きを再現）

### 2.3 ステージ構成（全5ステージ）

| ステージ | 距離 | 速度(px/s) | 最小ギャップ(px) | 傾斜制限 | 周期(px) | 壁の色 | 通路の色 | 特徴 |
|---------|------|------------|------------------|----------|----------|--------|----------|------|
| 1 | 50km | 175 | 340 | 25 | 600 | 緑系 | 薄い緑 | チュートリアル |
| 2 | 75km | 200 | 300 | 35 | 520 | 黄色系 | 薄い黄色 | 高さ制限追加 |
| 3 | 100km | 300 | 260 | 45 | 450 | 赤系 | 薄い赤 | 高速スクロール |
| 4 | 40km | 100 | 200 | 55 | 390 | 灰色系 | 明るい灰色 | 複雑な壁パターン |
| 5 | 150km | 800 | 250 | 700 | 900 | 紫系 | 薄い紫 | 最終ステージ |

### 2.4 ステージ実数パラメータ（実装値）
- **スクロール速度(px/s)**: [175, 200, 300, 100, 800]
- **最小ギャップ幅(px)**: [340, 300, 260, 200, 250]
- **目標クリア時間目安**: 各ステージ 1〜3 分（距離 ÷ 速度）
- **最小マージン**: 上下端から各20pxを確保（中心範囲を制限）
- **カーブ制約**: 洞窟中心線の傾斜を100pxあたりの上下変化量で制御
  - 上限(px/100px): [25, 35, 45, 55, 700]（ステージ1→5）
- **生成周期（中心線の基本周期）**: [600, 520, 450, 390, 900] px（ノイズ合成＋最小ギャップ保証）
- **色設定**: 各ステージで壁と通路の色が異なる（視覚的な区別）

## 3. 技術仕様

### 3.1 技術スタック
- **フロントエンド**: HTML5 + CSS3 + JavaScript (Vanilla JS)
- **描画**: HTML5 Canvas
- **音声**: Web Audio API
- **デプロイ**: GitHub Pages

### 3.2 対応ブラウザ
- Chrome (最新版)
- Firefox (最新版)
- Safari (最新版)
- Edge (最新版)

### 3.3 画面/解像度
- **Canvas解像度**: 800x450（16:9）固定。
- **表示方式**: アスペクト比固定でレターボックス。拡大縮小はCSSスケール。
- **座標系**: 論理解像度は常に800x450（デバイスピクセル比に依存しない）。

## 4. 機能要件

### 4.1 ゲームエンジン
- 60FPSでのゲームループ
- フレームレート独立の物理演算
- 当たり判定システム
 - 固定タイムステップ: Δt = 1/60s（大きなフレーム落ち時はΔtを2フレーム分までクランプ）

### 4.2 ロケットシステム
- 物理演算による移動（重力・慣性）
- スペースキー入力の検知
- 壁との当たり判定
 - 当たり判定形状: 多角形（8頂点程度の凸ポリゴン）
 - 速度上限: 垂直速度 |Vy| ≤ 1200 px/s（初期値）
 - 物理パラメータ（初期値）: 重力 g = 1800 px/s^2、推力 a = 2400 px/s^2

### 4.3 洞窟システム
- ランダム生成による壁パターン
- ステージごとの難易度調整
- 右スクロール実装
 - 生成方式: 低周波ノイズ＋サイン波の合成で上下境界を生成し、最小ギャップ幅を常に保証。
 - 当たり判定: ポリゴン境界（上下境界をポリラインとして保持）。
 - 判定手法: SAT（分離軸定理）による多角形-多角形/多角形-線分判定。
 - 乱数シード: 任意で固定可能（再現性テスト用）。

### 4.4 ステージシステム
- 5ステージの段階的難易度上昇
- ステージ進行の管理
- クリア条件の判定

### 4.5 視覚効果
- **パーティクル効果**: 爆発時のエフェクト
- **背景スクロール**: ステージごとに雰囲気・色を変更
- **ロケット炎エフェクト**: 上昇時の炎の描画

### 4.6 音声システム
- **効果音**: Web Audio APIでリアルタイム生成
  - **スタート音**: メロディックな5音階（ドレミファソ）
  - **エンジン音**: 低周波ハム音（65Hz、ノイズ付き）
  - **クラッシュ音**: 4層構造の爆発音（「ボカーン」効果）
  - **ステージクリア音**: 3音階の成功音
- **音響制御**: 滑らかなフェードイン/アウト
- **モバイル対応**: タッチ操作時の音声コンテキスト自動開始

### 4.7 UI要素
- **HUD表示**: 
  - 左上: ステージ番号、現在距離（半透明黒背景）
  - 右上: 一時停止ボタン（浮遊ボタン）
- **ゲームオーバー画面**: 到達距離表示、タイトルへ戻るボタン
- **ゲームクリア画面**: 全ステージクリア表示、タイトルへ戻るボタン
- **タイトル画面**: ゲーム開始画面、操作説明、ベスト距離表示
- **モバイル対応**: タッチ操作説明、レスポンシブデザイン

## 5. 非機能要件

### 5.1 パフォーマンス
- 60FPSでの安定した動作
- メモリ使用量の最適化
- ローディング時間の短縮
 - パーティクル上限: 300個程度（状況により可変）

### 5.2 ユーザビリティ
- 直感的な操作（ワンボタン/ワンタップ）
- 明確なフィードバック（視覚・音響・振動）
- レスポンシブデザイン（画面サイズ対応）
- モバイル最適化（タッチ操作、UI配置）

### 5.3 互換性
- GitHub Pagesでの正常動作
- モバイルブラウザでの基本動作
- タッチ操作対応（画面タップ長押しで上昇）
- ハプティックフィードバック（モバイル対応）

### 5.4 データ保存
- 保存先: `localStorage`
- 保存内容: ベスト距離（累計距離）
- エンコーディング: UTF-8（日本語コメント対応）

## 6. ファイル構成

```
Cave-Escape/
├── index.html              # メインHTMLファイル
├── css/
│   └── style.css           # スタイルシート（レスポンシブ対応）
├── js/
│   ├── main.js             # メインゲームロジック・入力処理
│   ├── game.js             # ゲームエンジン・状態管理
│   ├── rocket.js           # ロケットクラス・物理演算
│   ├── cave.js             # 洞窟生成クラス・当たり判定
│   ├── stage.js            # ステージ設定データ
│   ├── particle.js         # パーティクルシステム
│   ├── sound.js            # 音声管理クラス（Web Audio API）
│   ├── ui.js               # UI管理クラス・描画
│   └── util.js             # ユーティリティ関数
├── docs/
│   └── requirements.md     # 要件定義書
└── README.md               # プロジェクト説明
```

### 6.1 実装済み機能
- ✅ ゲームエンジン（60FPS固定タイムステップ）
- ✅ ロケット物理演算（重力・慣性・推力）
- ✅ 洞窟生成システム（ノイズベース）
- ✅ 当たり判定（SAT多角形判定）
- ✅ ステージシステム（5ステージ）
- ✅ パーティクルエフェクト
- ✅ 音声システム（Web Audio API）
- ✅ UIシステム（HUD・オーバーレイ）
- ✅ モバイル対応（タッチ操作・レスポンシブ）
- ✅ データ保存（localStorage）

## 7. 技術的特徴

### 7.1 ゲームエンジン
- **固定タイムステップ**: 60FPSで安定した物理演算
- **フレームレート独立**: フレーム落ち時も物理演算が安定
- **メモリ効率**: パーティクル上限300個で最適化

### 7.2 物理演算
- **重力**: 900 px/s²
- **推力**: 1200 px/s²
- **最大速度**: 700 px/s
- **慣性**: 放物線軌道で自然な動き

### 7.3 音響システム
- **リアルタイム生成**: Web Audio APIで動的音声生成
- **4層構造**: エンジン音、ノイズ、変調、フィルタ
- **滑らかな制御**: フェードイン/アウトで自然な音

### 7.4 モバイル最適化
- **タッチ操作**: 画面タップで上昇制御
- **レスポンシブ**: 画面サイズに応じた表示調整
- **ハプティック**: 振動フィードバック
- **バッテリー節約**: バックグラウンド時は一時停止

## 8. 承認事項

- [x] ゲーム仕様の承認
- [x] 技術仕様の承認
- [x] 機能要件の承認
- [x] ファイル構成の承認
- [x] 実装完了

---

**作成日**: 2025年1月27日  
**バージョン**: 2.0（実装完了版）  
**承認者**: 開発者  
**承認日**: 2025年1月27日
